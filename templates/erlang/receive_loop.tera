%%%
%%% Generated Worker Actor Loop
%%%
%%% Auto-generated by ggen from ontology/worker.ttl
%%% DO NOT EDIT: changes will be overwritten
%%%
%%% Runs in AtomVM as the main receive loop for the Worker actor.
%%% - Receives messages from mailbox
%%% - Dispatches to Rust NIF handler
%%% - Sends replies back to caller
%%%

-module(worker).
-export([start/0, loop/1, stop/0]).

%% Atom definitions (must match generated atoms.rs)
-define(WORKER_ID, 1).  % Unique actor ID
-define(NIF_MODULE, kgc_nif).

%%%
%%% Public API
%%%

%% Start the worker actor loop
start() ->
    spawn(?MODULE, loop, [initial_state()]).

%% Stop the actor
stop() ->
    whereis(worker) ! stop.

%%%
%%% Implementation
%%%

%% Initial state for Worker: {count = 0}
initial_state() ->
    #{
        count => 0
    }.

%% Main receive loop
%% Stays alive waiting for messages
loop(State) ->
    receive
        {inc, By} ->
            %% Call Rust handler via NIF
            case ?NIF_MODULE:dispatch(?WORKER_ID, {inc, By}) of
                {ok, NewCount} ->
                    %% Update state and continue
                    NewState = State#{count => NewCount},
                    loop(NewState);
                {error, Reason} ->
                    %% Log error and continue (actor doesn't crash)
                    io:format("Worker inc error: ~p~n", [Reason]),
                    loop(State)
            end;

        {get, From} ->
            %% Call Rust handler via NIF
            case ?NIF_MODULE:dispatch(?WORKER_ID, get) of
                {ok, Count} ->
                    %% Send reply to caller
                    From ! {reply, Count},
                    loop(State);
                {error, Reason} ->
                    %% Send error reply
                    From ! {error, Reason},
                    loop(State)
            end;

        stop ->
            %% Graceful shutdown
            io:format("Worker actor stopping~n", []),
            ok;

        Unknown ->
            %% Unknown message - log and continue
            io:format("Worker received unknown message: ~p~n", [Unknown]),
            loop(State)
    end.

%%%
%%% Test helpers (when running in test mode)
%%%

-ifdef(TEST).

test_inc_single() ->
    Pid = start(),
    Pid ! {inc, 5},
    timer:sleep(100),
    ok.

test_inc_multi() ->
    Pid = start(),
    Pid ! {inc, 1},
    Pid ! {inc, 2},
    Pid ! {inc, 3},
    timer:sleep(100),
    ok.

test_get() ->
    Pid = start(),
    Pid ! {inc, 42},
    timer:sleep(50),
    Pid ! {get, self()},
    receive
        {reply, Count} ->
            Count =:= 42  % Assertion
    after 1000 ->
        false
    end.

-endif.
